<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ticket Tracking</title>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --btn:#0f172a;
      --btnText:#fff;
      --pill:#eef2ff;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }
    .wrap{
      max-width: 980px;
      margin: 40px auto 80px;
      padding: 0 16px;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:22px;
    }
    .title h1{
      margin:0;
      font-size: 40px;
      letter-spacing:-.02em;
    }
    .title p{
      margin:6px 0 0;
      color: var(--muted);
    }
    .top-actions{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .btn{
      border:0;
      background: var(--btn);
      color: var(--btnText);
      padding: 10px 14px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
    }
    .btn.secondary{
      background: #fff;
      color: var(--text);
      border: 1px solid var(--line);
    }
    .grid{
      display:grid;
      gap:16px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 880px){
      .grid{
        grid-template-columns: 1fr;
      }
    }
    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(226,232,240,.8);
      overflow:hidden;
    }
    .card .hd{
      padding: 18px 18px 12px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .card .hd h2{
      margin:0;
      font-size: 18px;
      letter-spacing:-.01em;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
    }
    .pill.status{ background: var(--pill); border-color: #c7d2fe; }
    .pill.ok{ background:#ecfdf5; border-color:#a7f3d0; }
    .pill.warn{ background:#fff7ed; border-color:#fed7aa; }
    .pill.bad{ background:#fef2f2; border-color:#fecaca; }
    .card .bd{
      padding: 18px;
    }
    .meta{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px 22px;
      margin-top: 10px;
    }
    .meta .k{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .meta .v{
      font-size: 14px;
      font-weight: 650;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .desc{
      margin-top: 14px;
    }
    .desc .k{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    .desc .v{
      font-size: 14px;
      line-height: 1.45;
      background:#f8fafc;
      border:1px solid var(--line);
      padding: 12px;
      border-radius: 12px;
      white-space:pre-wrap;
    }

    .subline{
      margin-top: 12px;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .dot{ opacity:.6; }

    .alert{
      margin-top: 12px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #fecaca;
      background: #fef2f2;
      color:#991b1b;
      font-weight:600;
      font-size: 13px;
    }

    /* Replies */
    .replies{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .reply{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background: #fff;
    }
    .reply .top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      margin-bottom: 8px;
    }
    .reply .from{
      font-weight:800;
      font-size: 13px;
    }
    .reply .time{
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .reply .text{
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .empty{
      color: var(--muted);
      font-size: 13px;
      padding: 10px 2px;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(2,6,23,.5);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width: min(520px, 100%);
      background: #fff;
      border-radius: 18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(226,232,240,.8);
      overflow:hidden;
    }
    .modal .mh{
      padding: 16px 16px 10px;
      border-bottom: 1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
    }
    .modal .mh h3{ margin:0; font-size: 16px; }
    .modal .mb{ padding: 16px; }
    .modal label{ display:block; font-size:12px; color: var(--muted); margin-bottom:6px; }
    .modal input{
      width:100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      outline:none;
      font-size: 15px;
    }
    .modal .ma{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      padding: 0 16px 16px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Ticket Tracking</h1>
        <p>Track status and support replies using your ticket code.</p>
      </div>
      <div class="top-actions">
        <button class="btn" id="btnChange">Change code</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="hd">
          <h2>Ticket</h2>
          <div style="display:flex; gap:10px; align-items:center;">
            <span class="pill status" id="pillStatus">—</span>
            <button class="btn secondary" id="btnRefresh">Refresh</button>
          </div>
        </div>
        <div class="bd">
          <div class="meta">
            <div>
              <div class="k">Ticket Code</div>
              <div class="v" id="vCode">—</div>
            </div>
            <div>
              <div class="k">Priority</div>
              <div class="v" id="vPriority">—</div>
            </div>

            <div>
              <div class="k">Subject</div>
              <div class="v" id="vSubject">—</div>
            </div>
            <div>
              <div class="k">Last Updated</div>
              <div class="v" id="vUpdated">—</div>
            </div>

            <div>
              <div class="k">Created</div>
              <div class="v" id="vCreated">—</div>
            </div>
            <div>
              <div class="k">Closed</div>
              <div class="v" id="vClosed">—</div>
            </div>
          </div>

          <div class="desc">
            <div class="k">Description</div>
            <div class="v" id="vDesc">—</div>
          </div>

          <div id="alertBox" class="alert" style="display:none;"></div>

          <div class="subline">
            <span>Auto refresh: every <b>20s</b></span>
            <span class="dot">•</span>
            <span>Last checked: <span id="lastChecked">—</span></span>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <h2>Replies</h2>
          <span class="pill" id="replyCount">0</span>
        </div>
        <div class="bd">
          <div class="replies" id="replyList"></div>
          <div class="empty" id="replyEmpty" style="display:none;">
            No replies yet. Please wait — support will update this ticket.
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="mh">
        <h3>Enter Ticket Code</h3>
        <button class="btn secondary" id="btnCloseModal">Close</button>
      </div>
      <div class="mb">
        <label for="inpCode">Ticket Code</label>
        <input id="inpCode" placeholder="e.g. 564" inputmode="numeric" />
      </div>
      <div class="ma">
        <button class="btn secondary" id="btnCancel">Cancel</button>
        <button class="btn" id="btnSaveCode">Save</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * CONFIG (EDIT THIS)
     ***********************/
    const API_BASE = "https://script.google.com/macros/s/AKfycbzmuoo7x3aANn-d0UzxK2pqsPwufnW0tIDhkMftFjZ1wBLm-hkuDy0ouEvQvBJSsC1D8w/exec";
    // Example:
    // const API_BASE = "https://script.google.com/macros/s/AKfycbxxxxxx/exec";

    /***********************
     * HELPERS
     ***********************/
    const $ = (id) => document.getElementById(id);

    function fmtDate(s){
      if (!s) return "—";
      const d = new Date(s);
      if (isNaN(d.getTime())) return String(s);
      const pad = (n)=> String(n).padStart(2,"0");
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}, ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function setStatusPill(status){
      const el = $("pillStatus");
      const st = (status || "—").toString();
      el.textContent = st;

      // reset classes
      el.className = "pill status";

      if (st === "OPEN") el.classList.add("warn");
      else if (st === "IN_PROGRESS") el.classList.add("ok");
      else if (st === "SOLVED" || st === "CLOSED") el.classList.add("ok");
      else if (st === "REJECTED" || st === "CANCELLED") el.classList.add("bad");
    }

    function setAlert(msg){
      const box = $("alertBox");
      if (!msg){
        box.style.display = "none";
        box.textContent = "";
      } else {
        box.style.display = "block";
        box.textContent = msg;
      }
    }

    function getCodeFromUrl(){
      const u = new URL(location.href);
      return (u.searchParams.get("code") || "").trim();
    }

    function setCodeToUrl(code){
      const u = new URL(location.href);
      if (code) u.searchParams.set("code", code);
      else u.searchParams.delete("code");
      history.replaceState({}, "", u.toString());
    }

    function renderReplies(thread){
      const list = $("replyList");
      list.innerHTML = "";

      const arr = Array.isArray(thread) ? thread : [];
      $("replyCount").textContent = String(arr.length);
      $("replyEmpty").style.display = arr.length ? "none" : "block";

      for (const m of arr){
        const div = document.createElement("div");
        div.className = "reply";
        div.innerHTML = `
          <div class="top">
            <div class="from">${escapeHtml(m.from || "Support")}</div>
            <div class="time">${escapeHtml(fmtDate(m.at))}</div>
          </div>
          <div class="text">${escapeHtml(m.text || "")}</div>
        `;
        list.appendChild(div);
      }
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function fetchTicket(code){
      // Apps Script should accept: ?code=564
      const url = `${API_BASE}?code=${encodeURIComponent(code)}`;
      const r = await fetch(url, { method: "GET" });
      if (!r.ok) throw new Error(`API error: ${r.status}`);
      return await r.json();
    }

    /***********************
     * MAIN
     ***********************/
    let currentCode = getCodeFromUrl();
    let timer = null;

    async function refresh(){
      const code = currentCode;
      $("lastChecked").textContent = fmtDate(new Date().toISOString());
      setAlert("");

      if (!API_BASE || API_BASE.includes("PASTE_YOUR_APPS_SCRIPT_WEBAPP_URL_HERE")){
        setAlert("Setup needed: Please paste your Apps Script Web App URL into API_BASE in index.html.");
        return;
      }

      if (!code){
        setAlert("No ticket code. Click “Change code” and enter your ticket number.");
        return;
      }

      $("vCode").textContent = code;

      try{
        const data = await fetchTicket(code);

        if (!data || data.success !== true || !data.ticket){
          setAlert("Ticket not found");
          setStatusPill("—");
          $("vSubject").textContent = "—";
          $("vPriority").textContent = "—";
          $("vCreated").textContent = "—";
          $("vUpdated").textContent = "—";
          $("vClosed").textContent = "—";
          $("vDesc").textContent = "—";
          renderReplies([]);
          return;
        }

        const t = data.ticket;

        setStatusPill(t.status);
        $("vCode").textContent = t.code ?? code;
        $("vSubject").textContent = t.subject || "—";
        $("vPriority").textContent = t.priority || "—";
        $("vCreated").textContent = fmtDate(t.created_at);
        $("vUpdated").textContent = fmtDate(t.updated_at);
        $("vClosed").textContent = t.closed_time ? fmtDate(t.closed_time) : "—";
        $("vDesc").textContent = (t.description && String(t.description).trim()) ? t.description : "—";

        renderReplies(t.thread || []);

      } catch(err){
        console.error(err);
        setAlert("Error loading ticket. Please try again.");
      }
    }

    function startAutoRefresh(){
      if (timer) clearInterval(timer);
      timer = setInterval(refresh, 20000);
    }

    /***********************
     * UI EVENTS
     ***********************/
    function openModal(){
      $("modalBackdrop").style.display = "flex";
      $("inpCode").value = currentCode || "";
      setTimeout(()=> $("inpCode").focus(), 50);
    }
    function closeModal(){
      $("modalBackdrop").style.display = "none";
    }

    $("btnChange").addEventListener("click", openModal);
    $("btnCloseModal").addEventListener("click", closeModal);
    $("btnCancel").addEventListener("click", closeModal);
    $("modalBackdrop").addEventListener("click", (e)=>{
      if (e.target === $("modalBackdrop")) closeModal();
    });

    $("btnSaveCode").addEventListener("click", ()=>{
      const v = ($("inpCode").value || "").trim();
      if (!v){
        currentCode = "";
        setCodeToUrl("");
        closeModal();
        refresh();
        return;
      }
      currentCode = v;
      setCodeToUrl(v);
      closeModal();
      refresh();
    });

    $("btnRefresh").addEventListener("click", refresh);

    // Boot
    (async function init(){
      if (!currentCode) openModal();
      await refresh();
      startAutoRefresh();
    })();
  </script>
</body>
</html>
