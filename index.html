<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ticket Tracking</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --shadow: 0 12px 30px rgba(15, 23, 42, .08);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 600px at 50% 0%, #eef2ff 0%, var(--bg) 60%);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:34px 18px 60px}
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:16px;
      margin-bottom:18px;
    }
    h1{margin:0;font-size:44px;letter-spacing:-.02em}
    .sub{margin-top:6px;color:var(--muted);font-size:14px}
    .btn{
      border:1px solid var(--border);
      background:#0b1220;
      color:#fff;
      padding:12px 16px;
      border-radius:999px;
      cursor:pointer;
      font-weight:600;
      box-shadow: 0 12px 22px rgba(0,0,0,.08);
    }
    .btn.secondary{
      background:#fff;color:#0b1220;
      box-shadow:none;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      margin-top:18px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      display:flex;align-items:center;justify-content:space-between;
      padding:16px 18px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
    }
    .cardTitle{font-weight:800}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:12px;
      font-weight:700;
      letter-spacing:.02em;
      background:#fff;
    }
    .pill.dot::before{
      content:"";
      width:8px;height:8px;border-radius:999px;
      background:#94a3b8;
      display:inline-block;
    }
    .pill.OPEN.dot::before{background:#f59e0b}
    .pill.IN_PROGRESS.dot::before{background:#3b82f6}
    .pill.SOLVED.dot::before{background:#22c55e}
    .pill.CLOSED.dot::before{background:#22c55e}
    .pill.UNKNOWN.dot::before{background:#94a3b8}

    .content{padding:18px}
    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px 16px;
    }
    .k{color:var(--muted);font-size:12px;margin-bottom:6px}
    .v{font-weight:750}
    .desc{
      margin-top:14px;
      border:1px dashed var(--border);
      border-radius:14px;
      padding:14px;
      color:#0f172a;
      background:#fbfdff;
      white-space:pre-wrap;
    }
    .meta{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .error{
      margin-top:12px;
      background:#fff1f2;
      border:1px solid #fecdd3;
      color:#9f1239;
      padding:12px 14px;
      border-radius:14px;
      font-weight:650;
    }

    .replyHeader{
      display:flex;align-items:center;justify-content:space-between;
      padding:16px 18px;
      border-bottom:1px solid var(--border);
    }
    .count{font-size:12px;color:var(--muted);font-weight:700}
    .thread{padding:14px 18px 18px; display:flex; flex-direction:column; gap:10px;}
    .msg{
      border:1px solid var(--border);
      background:#fff;
      border-radius:16px;
      padding:12px 12px;
      max-width: 760px;
    }
    .msg .topline{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;margin-bottom:6px;
      font-size:12px;color:var(--muted);
    }
    .msg .who{font-weight:800;color:#0f172a}
    .msg .txt{white-space:pre-wrap; line-height:1.45}
    .msg.system{
      background:#f8fafc;
      border-style:dashed;
    }
    .msg.private{
      background:#fff7ed;
      border-color:#fed7aa;
    }

    .toolbar{
      display:flex; gap:10px; align-items:center;
    }

    @media (max-width: 720px){
      h1{font-size:34px}
      .kv{grid-template-columns:1fr}
      .top{flex-direction:column}
      .btn{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Ticket Tracking</h1>
        <div class="sub">Track status and support replies using your ticket code.</div>
      </div>
      <button class="btn" id="changeBtn">Change code</button>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">Ticket</div>
          <div class="toolbar">
            <span class="pill dot UNKNOWN" id="statusPill">UNKNOWN</span>
            <button class="btn secondary" id="refreshBtn">Refresh</button>
          </div>
        </div>

        <div class="content">
          <div class="kv">
            <div>
              <div class="k">Ticket Code</div>
              <div class="v" id="codeEl">—</div>
            </div>
            <div>
              <div class="k">Priority</div>
              <div class="v" id="prioEl">—</div>
            </div>

            <div>
              <div class="k">Subject</div>
              <div class="v" id="subjEl">—</div>
            </div>
            <div>
              <div class="k">Last Updated</div>
              <div class="v" id="updEl">—</div>
            </div>

            <div>
              <div class="k">Created</div>
              <div class="v" id="crtEl">—</div>
            </div>
            <div>
              <div class="k">Closed</div>
              <div class="v" id="clsEl">—</div>
            </div>
          </div>

          <div class="k" style="margin-top:14px">Description</div>
          <div class="desc" id="descEl">—</div>

          <div class="meta">
            <span>Auto refresh: every <b>20s</b></span>
            <span>•</span>
            <span>Last checked: <span id="lastChecked">—</span></span>
          </div>

          <div class="error" id="errBox" style="display:none"></div>
        </div>
      </div>

      <div class="card">
        <div class="replyHeader">
          <div class="cardTitle">Replies</div>
          <div class="count"><span id="replyCount">0</span></div>
        </div>
        <div class="thread" id="threadEl">
          <div style="color:var(--muted);font-weight:650">No replies yet. Please wait — support will update this ticket.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /** ✅ IMPORTANT: put your deployed Apps Script WEB APP URL here */
    const APP_SCRIPT_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzZGpBHZfQOdhjz1oszH15LB61gSF0P6zM05BonFVg8efy8ibPOnnUkKd-KNT0cjG7IMg/exec"; 
    const WORKSPACE_ID = "2a9e18d0-dae2-4d6d-8a66-f81ffa3f2d55";
    const AUTO_REFRESH_MS = 20000;

    const el = (id) => document.getElementById(id);

    function getCodeFromUrl() {
      const u = new URL(location.href);
      return (u.searchParams.get("code") || "").trim();
    }
    function setCodeInUrl(code) {
      const u = new URL(location.href);
      u.searchParams.set("code", code);
      history.replaceState({}, "", u.toString());
    }

    function fmtDate(v){
      if(!v) return "—";
      try{
        // handles ISO strings
        const d = new Date(v);
        if(isNaN(d.getTime())) return String(v);
        const dd = String(d.getDate()).padStart(2,"0");
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const yyyy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2,"0");
        const mi = String(d.getMinutes()).padStart(2,"0");
        const ss = String(d.getSeconds()).padStart(2,"0");
        return `${dd}/${mm}/${yyyy}, ${hh}:${mi}:${ss}`;
      }catch(e){
        return String(v);
      }
    }

    function setStatus(status){
      const s = (status || "UNKNOWN").toUpperCase();
      const pill = el("statusPill");
      pill.className = "pill dot " + s;
      pill.textContent = s;
    }

    function showError(msg){
      const b = el("errBox");
      b.style.display = "block";
      b.textContent = msg;
    }
    function clearError(){
      const b = el("errBox");
      b.style.display = "none";
      b.textContent = "";
    }

    // JSONP call (no CORS needed)
    function callApiJsonp(params) {
      return new Promise((resolve, reject) => {
        const cbName = "__cb_" + Math.random().toString(36).slice(2);
        window[cbName] = (data) => {
          cleanup();
          resolve(data);
        };

        const url = new URL(APP_SCRIPT_WEBAPP_URL);
        Object.keys(params).forEach(k => url.searchParams.set(k, params[k]));
        url.searchParams.set("callback", cbName);

        const script = document.createElement("script");
        script.src = url.toString();
        script.onerror = () => {
          cleanup();
          reject(new Error("Failed to load API (check Web App URL / deployment access)."));
        };
        document.body.appendChild(script);

        function cleanup(){
          try{ delete window[cbName]; }catch(e){ window[cbName] = undefined; }
          if(script && script.parentNode) script.parentNode.removeChild(script);
        }
      });
    }

    function renderThread(thread){
      const box = el("threadEl");
      const items = Array.isArray(thread) ? thread : [];
      el("replyCount").textContent = String(items.length || 0);

      if(!items.length){
        box.innerHTML = `<div style="color:var(--muted);font-weight:650">No replies yet. Please wait — support will update this ticket.</div>`;
        return;
      }

      box.innerHTML = "";
      items.forEach(m => {
        const type = (m.type || "").toLowerCase();
        const isPrivate = !!m.is_private;
        const cls = ["msg"];
        if(type.includes("system")) cls.push("system");
        if(isPrivate) cls.push("private");

        const who = (m.author_name || m.author_role || "Support");
        const when = fmtDate(m.created_at);
        const txt = (m.content || "").toString().trim();

        const safeTxt = txt
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/\n/g,"<br>");

        const badge = isPrivate ? " (Private note)" : "";

        const div = document.createElement("div");
        div.className = cls.join(" ");
        div.innerHTML = `
          <div class="topline">
            <div><span class="who">${who}</span><span style="color:var(--muted)">${badge}</span></div>
            <div>${when}</div>
          </div>
          <div class="txt">${safeTxt || "<span style='color:var(--muted)'>—</span>"}</div>
        `;
        box.appendChild(div);
      });
    }

    async function loadTicket(){
      const code = getCodeFromUrl();
      el("codeEl").textContent = code || "—";
      el("lastChecked").textContent = fmtDate(new Date());
      clearError();

      if(!code){
        showError("Missing code. Add ?code=### in URL or click Change code.");
        setStatus("UNKNOWN");
        renderThread([]);
        return;
      }

      try{
        const data = await callApiJsonp({
          code,
          workspace_id: WORKSPACE_ID,
          limit: 50,
          order: "asc"
        });

        if(!data || data.success !== true){
          setStatus("UNKNOWN");
          renderThread([]);
          showError((data && data.error) ? data.error : "Ticket not found / API error");
          // keep blanks
          el("subjEl").textContent = "—";
          el("prioEl").textContent = "—";
          el("crtEl").textContent = "—";
          el("updEl").textContent = "—";
          el("clsEl").textContent = "—";
          el("descEl").textContent = "—";
          return;
        }

        const t = data.ticket || {};
        setStatus(t.status || "UNKNOWN");

        el("codeEl").textContent = (t.code != null ? String(t.code) : code);
        el("subjEl").textContent = t.subject || "—";
        el("prioEl").textContent = t.priority || "—";
        el("crtEl").textContent = fmtDate(t.created_at);
        el("updEl").textContent = fmtDate(t.updated_at);
        el("clsEl").textContent = fmtDate(t.closed_time);
        el("descEl").textContent = (t.description && String(t.description).trim()) ? t.description : "—";

        // Show replies / timeline
        renderThread(data.thread || []);

      }catch(err){
        setStatus("UNKNOWN");
        renderThread([]);
        showError(err.message || String(err));
      }
    }

    el("refreshBtn").addEventListener("click", loadTicket);
    el("changeBtn").addEventListener("click", () => {
      const curr = getCodeFromUrl();
      const next = prompt("Enter ticket code", curr || "");
      if(next === null) return;
      const clean = String(next).trim();
      if(!clean) return;
      setCodeInUrl(clean);
      loadTicket();
    });

    // Boot
    (function init(){
      // If no code in URL, ask once
      if(!getCodeFromUrl()){
        const c = prompt("Enter ticket code (example: 559)", "");
        if(c && String(c).trim()){
          setCodeInUrl(String(c).trim());
        }
      }
      loadTicket();
      setInterval(loadTicket, AUTO_REFRESH_MS);
    })();
  </script>
</body>
</html>
