<!doctype html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ticket Tracking</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { color-scheme: light; }
    body { background: radial-gradient(1200px 600px at 50% 0%, rgba(99,102,241,.08), transparent), #f6f7fb; }
    .card { box-shadow: 0 18px 60px rgba(15, 23, 42, .08); }
    .mono { font-variant-numeric: tabular-nums; }
    .badge { border:1px solid rgba(15,23,42,.12); }
    .skeleton { background: linear-gradient(90deg, rgba(15,23,42,.06), rgba(15,23,42,.03), rgba(15,23,42,.06)); background-size: 200% 100%; animation: sk 1.2s infinite; }
    @keyframes sk { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-5xl mx-auto px-4 py-10">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-4xl font-extrabold tracking-tight text-slate-900" data-i18n="title">Ticket Tracking</h1>
        <p class="text-slate-600 mt-2" data-i18n="subtitle">Track status and support replies using your ticket code.</p>
      </div>

      <div class="flex items-center gap-2">
        <!-- Language Toggle -->
        <div class="inline-flex rounded-full bg-white badge p-1 card">
          <button id="btnBn" class="px-3 py-1.5 rounded-full text-sm font-semibold">বাংলা</button>
          <button id="btnEn" class="px-3 py-1.5 rounded-full text-sm font-semibold">English</button>
        </div>

        <button id="btnChangeCode"
          class="rounded-full bg-slate-900 text-white px-5 py-3 font-semibold shadow hover:bg-slate-800 transition"
          data-i18n="changeCode">
          Change code
        </button>
      </div>
    </div>

    <!-- Main Card -->
    <div class="mt-8 card bg-white rounded-2xl overflow-hidden border border-slate-200">
      <div class="px-6 py-5 border-b border-slate-200 flex items-center justify-between">
        <div class="text-lg font-extrabold text-slate-900" data-i18n="ticketHeader">Ticket</div>

        <div class="flex items-center gap-2">
          <span id="statusPill" class="badge px-3 py-1.5 rounded-full text-xs font-bold tracking-wide uppercase text-slate-700">
            • UNKNOWN
          </span>
          <button id="btnRefresh" class="rounded-full badge px-4 py-2 text-sm font-semibold hover:bg-slate-50 transition" data-i18n="refresh">
            Refresh
          </button>
        </div>
      </div>

      <div class="px-6 py-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="space-y-5">
            <div>
              <div class="text-xs tracking-wider uppercase text-slate-500" data-i18n="ticketCodeLbl">Ticket Code</div>
              <div class="text-xl font-extrabold text-slate-900 mono" id="ticketCode">—</div>
            </div>

            <div>
              <div class="text-xs tracking-wider uppercase text-slate-500" data-i18n="subjectLbl">Subject</div>
              <div class="text-base font-semibold text-slate-900" id="subject">—</div>
            </div>

            <div>
              <div class="text-xs tracking-wider uppercase text-slate-500" data-i18n="createdLbl">Created</div>
              <div class="text-base font-semibold text-slate-900 mono" id="createdAt">—</div>
            </div>
          </div>

          <div class="space-y-5">
            <div>
              <div class="text-xs tracking-wider uppercase text-slate-500" data-i18n="priorityLbl">Priority</div>
              <div class="text-base font-semibold text-slate-900 mono" id="priority">—</div>
            </div>

            <div>
              <div class="text-xs tracking-wider uppercase text-slate-500" data-i18n="updatedLbl">Last Updated</div>
              <div class="text-base font-semibold text-slate-900 mono" id="updatedAt">—</div>
            </div>

            <div>
              <div class="text-xs tracking-wider uppercase text-slate-500" data-i18n="closedLbl">Closed</div>
              <div class="text-base font-semibold text-slate-900 mono" id="closedAt">—</div>
            </div>
          </div>
        </div>

        <div class="mt-6">
          <div class="text-xs tracking-wider uppercase text-slate-500" data-i18n="descLbl">Description</div>
          <div class="mt-2 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-slate-900" id="description">—</div>
        </div>

        <div class="mt-4 text-xs text-slate-500">
          <span data-i18n="autoRefresh">Auto refresh: every 20s</span>
          <span class="mx-2">•</span>
          <span data-i18n="lastChecked">Last checked:</span>
          <span id="lastChecked" class="mono">—</span>
        </div>

        <div id="ticketError" class="hidden mt-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 font-semibold"></div>
      </div>
    </div>

    <!-- Replies -->
    <div class="mt-6 card bg-white rounded-2xl overflow-hidden border border-slate-200">
      <div class="px-6 py-5 border-b border-slate-200 flex items-center justify-between">
        <div class="text-lg font-extrabold text-slate-900" data-i18n="repliesHeader">Replies</div>
        <span id="replyCount" class="badge px-3 py-1.5 rounded-full text-xs font-bold text-slate-700">0</span>
      </div>

      <div class="px-6 py-6">
        <div id="repliesEmpty" class="text-slate-600" data-i18n="noReplies">
          No replies yet. Please wait — support will update this ticket.
        </div>

        <div id="repliesList" class="hidden space-y-4"></div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const API_BASE = "https://script.google.com/macros/s/AKfycbxZ2sndk__eO1h6CVdKqZ6kLi-mt8R8Nry5eJ2KtE59Iq5Glfpdy0JkwxxpszuYfi0Y/exec"; // <-- your Apps Script web app URL
    const AUTO_REFRESH_MS = 20000;

    /***********************
     * i18n
     ***********************/
    const I18N = {
      bn: {
        title: "টিকিট ট্র্যাকিং",
        subtitle: "আপনার টিকিট কোড দিয়ে স্ট্যাটাস ও সাপোর্ট রিপ্লাই দেখুন।",
        changeCode: "কোড পরিবর্তন",
        ticketHeader: "টিকিট",
        refresh: "রিফ্রেশ",
        ticketCodeLbl: "টিকিট কোড",
        subjectLbl: "বিষয়",
        createdLbl: "তৈরি হয়েছে",
        priorityLbl: "প্রাধান্য",
        updatedLbl: "সর্বশেষ আপডেট",
        closedLbl: "বন্ধ",
        descLbl: "বিবরণ",
        autoRefresh: "অটো রিফ্রেশ: প্রতি ২০ সেকেন্ডে",
        lastChecked: "শেষ চেক:",
        repliesHeader: "রিপ্লাই",
        noReplies: "এখনও কোনো রিপ্লাই নেই। অনুগ্রহ করে অপেক্ষা করুন — সাপোর্ট টিকিট আপডেট করবে।",
        promptCode: "আপনার টিকিট কোড লিখুন:",
        invalidCode: "অবৈধ কোড। দয়া করে আবার চেষ্টা করুন।",
        ticketNotFound: "টিকিট পাওয়া যায়নি",
        affiliateSupport: "অ্যাফিলিয়েট সাপোর্ট"
      },
      en: {
        title: "Ticket Tracking",
        subtitle: "Track status and support replies using your ticket code.",
        changeCode: "Change code",
        ticketHeader: "Ticket",
        refresh: "Refresh",
        ticketCodeLbl: "Ticket Code",
        subjectLbl: "Subject",
        createdLbl: "Created",
        priorityLbl: "Priority",
        updatedLbl: "Last Updated",
        closedLbl: "Closed",
        descLbl: "Description",
        autoRefresh: "Auto refresh: every 20s",
        lastChecked: "Last checked:",
        repliesHeader: "Replies",
        noReplies: "No replies yet. Please wait — support will update this ticket.",
        promptCode: "Enter your ticket code:",
        invalidCode: "Invalid code. Please try again.",
        ticketNotFound: "Ticket not found",
        affiliateSupport: "Affiliate Support"
      }
    };

    function getLang() {
      const saved = localStorage.getItem("tt_lang");
      return saved === "en" ? "en" : "bn";
    }
    function setLang(lang) {
      localStorage.setItem("tt_lang", lang);
      applyLang(lang);
      styleLangButtons(lang);
      // also re-render empty label text instantly
      const empty = document.getElementById("repliesEmpty");
      if (!empty.classList.contains("hidden")) empty.textContent = I18N[lang].noReplies;
    }
    function applyLang(lang) {
      document.documentElement.lang = lang;
      const dict = I18N[lang];
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (dict[key]) el.textContent = dict[key];
      });
    }
    function styleLangButtons(lang) {
      const activeCls = "bg-slate-900 text-white shadow";
      const idleCls = "text-slate-700 hover:bg-slate-50";
      const btnBn = document.getElementById("btnBn");
      const btnEn = document.getElementById("btnEn");
      btnBn.className = "px-3 py-1.5 rounded-full text-sm font-semibold transition " + (lang === "bn" ? activeCls : idleCls);
      btnEn.className = "px-3 py-1.5 rounded-full text-sm font-semibold transition " + (lang === "en" ? activeCls : idleCls);
    }

    /***********************
     * Helpers
     ***********************/
    function qs(name) {
      const u = new URL(location.href);
      return u.searchParams.get(name);
    }
    function setQueryParam(key, value) {
      const u = new URL(location.href);
      if (!value) u.searchParams.delete(key);
      else u.searchParams.set(key, value);
      history.replaceState(null, "", u.toString());
    }
    function formatDT(iso) {
      if (!iso) return "—";
      try {
        const d = new Date(iso);
        const pad = (n) => String(n).padStart(2, "0");
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}, ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      } catch { return "—"; }
    }
    function cleanMessageText(input) {
      if (!input) return "";
      let s = String(input);
      s = s.replaceAll("&nbsp;", " ")
           .replaceAll("&amp;", "&")
           .replaceAll("&lt;", "<")
           .replaceAll("&gt;", ">")
           .replaceAll("&quot;", '"')
           .replaceAll("&#39;", "'");
      s = s.replace(/<\/?[^>]+(>|$)/g, "");
      s = s.replace(/\s+/g, " ").trim();
      return s;
    }

    function setStatusPill(statusRaw) {
      const pill = document.getElementById("statusPill");
      const status = String(statusRaw || "UNKNOWN").toUpperCase();
      pill.textContent = `• ${status}`;

      pill.classList.remove(
        "text-slate-700","bg-white","border-slate-200",
        "text-blue-700","bg-blue-50","border-blue-200",
        "text-green-700","bg-green-50","border-green-200",
        "text-amber-700","bg-amber-50","border-amber-200",
        "text-red-700","bg-red-50","border-red-200"
      );

      let cls = ["text-slate-700","bg-white","border-slate-200"];
      if (status.includes("IN_PROGRESS") || status.includes("IN-PROGRESS")) cls = ["text-blue-700","bg-blue-50","border-blue-200"];
      else if (status.includes("SOLVED") || status.includes("RESOLVED")) cls = ["text-green-700","bg-green-50","border-green-200"];
      else if (status.includes("OPEN")) cls = ["text-amber-700","bg-amber-50","border-amber-200"];
      else if (status.includes("ESCAL")) cls = ["text-red-700","bg-red-50","border-red-200"];
      pill.classList.add(...cls);
    }

    function showError(msg) {
      const el = document.getElementById("ticketError");
      if (!msg) { el.classList.add("hidden"); el.textContent = ""; return; }
      el.classList.remove("hidden");
      el.textContent = msg;
    }

    /***********************
     * IMPORTANT FIX ✅
     * Replies can be in many places depending on script response.
     ***********************/
    function extractReplies(payload) {
      // Try all possible locations
      const candidates = [
        payload?.ticket?.thread,
        payload?.ticket?.messages,
        payload?.thread,
        payload?.messages,
        payload?.data?.thread,
        payload?.data?.messages,
        payload?.ticket?.data?.messages
      ];
      for (const c of candidates) {
        if (Array.isArray(c) && c.length) return c;
      }
      return [];
    }

    /***********************
     * API Calls (Apps Script)
     ***********************/
    async function apiFetchTicket(code) {
      const url = `${API_BASE}${API_BASE.includes("?") ? "&" : "?"}code=${encodeURIComponent(code)}&format=json`;
      const res = await fetch(url, { cache: "no-store" });
      return await res.json();
    }

    /***********************
     * Render
     ***********************/
    function renderTicket(payload) {
      const lang = getLang();
      const t = I18N[lang];

      // ticket object can be in payload.ticket OR payload.data.ticket
      const tk = payload?.ticket || payload?.data?.ticket;

      if (!payload || payload.success !== true || !tk) {
        setStatusPill("UNKNOWN");
        document.getElementById("ticketCode").textContent = currentCode || "—";
        document.getElementById("subject").textContent = "—";
        document.getElementById("createdAt").textContent = "—";
        document.getElementById("priority").textContent = "—";
        document.getElementById("updatedAt").textContent = "—";
        document.getElementById("closedAt").textContent = "—";
        document.getElementById("description").textContent = "—";
        renderReplies([]);
        return;
      }

      document.getElementById("ticketCode").textContent = tk.code ?? "—";
      document.getElementById("subject").textContent = tk.subject || "—";
      document.getElementById("createdAt").textContent = formatDT(tk.created_at);
      document.getElementById("priority").textContent = tk.priority || "—";
      document.getElementById("updatedAt").textContent = formatDT(tk.updated_at);
      document.getElementById("closedAt").textContent = tk.closed_time ? formatDT(tk.closed_time) : "—";
      document.getElementById("description").textContent = tk.description || "—";
      setStatusPill(tk.status);

      const replies = extractReplies(payload);
      renderReplies(replies);
    }

    function renderReplies(thread) {
      const lang = getLang();
      const t = I18N[lang];

      document.getElementById("replyCount").textContent = String(thread.length);

      const empty = document.getElementById("repliesEmpty");
      const list = document.getElementById("repliesList");

      if (!thread.length) {
        empty.classList.remove("hidden");
        empty.textContent = t.noReplies;
        list.classList.add("hidden");
        list.innerHTML = "";
        return;
      }

      empty.classList.add("hidden");
      list.classList.remove("hidden");

      list.innerHTML = thread.map(msg => {
        const when = formatDT(msg.created_at || msg.createdAt || msg.time || msg.timestamp);
        const body = cleanMessageText(msg.message || msg.content || msg.text || msg.body || "");
        const who = t.affiliateSupport; // always show Affiliate Support (not System)

        return `
          <div class="flex justify-end">
            <div class="max-w-xl w-full sm:w-auto">
              <div class="bg-white border border-slate-200 rounded-2xl p-4 card">
                <div class="text-slate-900 font-semibold">${body || "—"}</div>
                <div class="mt-3 flex items-center gap-2 text-xs text-slate-500">
                  <span class="badge px-2 py-0.5 rounded-full bg-slate-50 text-slate-700 font-bold">${who}</span>
                  <span class="mono">${when}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    /***********************
     * App State / Events
     ***********************/
    let currentCode = "";

    async function load() {
      const lang = getLang();
      const t = I18N[lang];

     if (!API_BASE || API_BASE.includes("PASTE_YOUR_APPS_SCRIPT_WEBAPP_URL_HERE")) {
        showError("API_BASE not set. Paste your Apps Script Web App URL inside index.html (API_BASE).");
        return;
      }

      showError("");

      try {
        const payload = await apiFetchTicket(currentCode);
        renderTicket(payload);

        if (payload && payload.success === false) {
          showError(payload.error || t.ticketNotFound);
        }
      } catch (e) {
        showError("Error loading ticket. Please try again.");
      } finally {
        document.getElementById("lastChecked").textContent = formatDT(new Date().toISOString());
      }
    }

    function promptChangeCode() {
      const lang = getLang();
      const t = I18N[lang];

      const next = prompt(t.promptCode, currentCode || "");
      if (next === null) return;
      const cleaned = String(next).trim();

      if (!cleaned || !/^\d+$/.test(cleaned)) {
        alert(t.invalidCode);
        return;
      }

      currentCode = cleaned;
      setQueryParam("code", cleaned);
      load();
    }

    document.getElementById("btnRefresh").addEventListener("click", load);
    document.getElementById("btnChangeCode").addEventListener("click", promptChangeCode);
    document.getElementById("btnBn").addEventListener("click", () => setLang("bn"));
    document.getElementById("btnEn").addEventListener("click", () => setLang("en"));

    // Init
    (function init() {
      const lang = getLang();
      applyLang(lang);
      styleLangButtons(lang);

      const code = (qs("code") || "").trim();
      if (!code || !/^\d+$/.test(code)) {
        currentCode = "";
        promptChangeCode();
      } else {
        currentCode = code;
        document.getElementById("ticketCode").textContent = code;
        load();
      }

      setInterval(() => {
        if (currentCode) load();
      }, AUTO_REFRESH_MS);
    })();
  </script>
</body>
</html>
