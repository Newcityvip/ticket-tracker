<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ticket Tracking</title>
  <style>
    :root{
      --bg:#f4f7ff;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#64748b;
      --border:#dbe3ff;
      --shadow: 0 14px 45px rgba(2,8,23,.10);
      --shadow2: 0 10px 30px rgba(2,8,23,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: radial-gradient(1200px 600px at 50% 0%, #e9efff 0%, var(--bg) 60%, #f7f9ff 100%);
      color:var(--text);
    }
    .wrap{max-width:1050px;margin:0 auto;padding:34px 18px 64px}
    .top{
      display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:18px
    }
    h1{margin:0;font-size:44px;letter-spacing:-.02em}
    .sub{margin-top:6px;color:var(--muted)}
    .btn{
      appearance:none;border:1px solid rgba(2,6,23,.10);
      background:#0b1220;color:#fff;
      padding:12px 18px;border-radius:14px;
      font-weight:700;cursor:pointer;
      box-shadow: var(--shadow2);
    }
    .btn:active{transform:translateY(1px)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .card{
      background:var(--card);
      border:1px solid rgba(2,6,23,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      display:flex;align-items:center;justify-content:space-between;
      padding:18px 20px;border-bottom:1px solid rgba(2,6,23,.07);
      background: linear-gradient(180deg, rgba(233,239,255,.65) 0%, rgba(255,255,255,.0) 100%);
    }
    .cardHead h2{margin:0;font-size:18px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 11px;border-radius:999px;
      border:1px solid rgba(2,6,23,.12);
      font-weight:800;font-size:12px;
      background:#fff;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:#94a3b8}
    .status-OPEN .dot{background:#f59e0b}
    .status-IN_PROGRESS .dot{background:#3b82f6}
    .status-SOLVED .dot{background:#22c55e}
    .status-CLOSED .dot{background:#64748b}
    .status-UNKNOWN .dot{background:#94a3b8}

    .row{display:flex;gap:10px;align-items:center}
    .miniBtn{
      appearance:none;background:#fff;border:1px solid rgba(2,6,23,.10);
      padding:9px 12px;border-radius:12px;font-weight:800;cursor:pointer;
    }
    .miniBtn:hover{background:#f8fafc}

    .content{padding:18px 20px}
    .kv{
      display:grid;grid-template-columns: 180px 1fr 180px 1fr;
      gap:14px 18px;
      padding:4px 0 10px;
    }
    .k{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.08em}
    .v{font-weight:800}
    .desc{
      margin-top:10px;
      border:1px dashed rgba(2,6,23,.18);
      border-radius:14px;padding:12px 14px;
      color:#111827;background:#fbfdff;
      min-height:44px;
      white-space:pre-wrap;
    }
    .footerLine{
      margin-top:12px;color:var(--muted);font-size:12px;
      display:flex;gap:12px;flex-wrap:wrap;
    }
    .alert{
      margin-top:14px;
      border:1px solid rgba(239,68,68,.35);
      background:rgba(239,68,68,.07);
      color:#b91c1c;
      border-radius:14px;
      padding:12px 14px;
      font-weight:700;
      white-space:pre-wrap;
    }

    /* Replies */
    .replyWrap{padding:18px 20px}
    .replyList{display:flex;flex-direction:column;gap:10px}
    .bubble{
      max-width:720px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(2,6,23,.10);
      background:#fff;
      box-shadow: 0 6px 20px rgba(2,8,23,.06);
      white-space:pre-wrap;
      line-height:1.35;
    }
    .bubble .meta{
      margin-top:8px;color:var(--muted);font-size:12px;font-weight:700;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
    }
    .me{align-self:flex-end;background:#eef6ff;border-color:rgba(59,130,246,.20)}
    .agent{align-self:flex-start;background:#f1fff5;border-color:rgba(34,197,94,.20)}
    .sys{align-self:center;background:#f8fafc;border-style:dashed;max-width:860px}
    .badge{
      font-size:11px;font-weight:900;
      padding:3px 8px;border-radius:999px;border:1px solid rgba(2,6,23,.10);
      color:#0b1220;background:#fff;
    }
    .empty{
      color:var(--muted);
      font-weight:700;
      padding:10px 0;
    }

    @media (max-width: 860px){
      h1{font-size:34px}
      .kv{grid-template-columns: 1fr 1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Ticket Tracking</h1>
        <div class="sub">Track status and support replies using your ticket code.</div>
      </div>
      <button class="btn" id="changeBtn">Change code</button>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHead">
          <div class="row">
            <h2>Ticket</h2>
          </div>
          <div class="row">
            <span class="pill status-UNKNOWN" id="statusPill"><span class="dot"></span><span id="statusText">UNKNOWN</span></span>
            <button class="miniBtn" id="refreshBtn">Refresh</button>
          </div>
        </div>

        <div class="content">
          <div class="kv">
            <div class="k">Ticket Code</div><div class="v" id="codeV">—</div>
            <div class="k">Priority</div><div class="v" id="priorityV">—</div>

            <div class="k">Subject</div><div class="v" id="subjectV">—</div>
            <div class="k">Last Updated</div><div class="v" id="updatedV">—</div>

            <div class="k">Created</div><div class="v" id="createdV">—</div>
            <div class="k">Closed</div><div class="v" id="closedV">—</div>
          </div>

          <div class="k">Description</div>
          <div class="desc" id="descV">—</div>

          <div class="footerLine">
            <span>Auto refresh: every <b>20s</b></span>
            <span>•</span>
            <span>Last checked: <b id="checkedV">—</b></span>
          </div>

          <div class="alert" id="errBox" style="display:none"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <h2>Replies</h2>
          <span class="pill"><span class="dot"></span><span id="replyCount">0</span></span>
        </div>
        <div class="replyWrap">
          <div class="replyList" id="replyList"></div>
          <div class="empty" id="emptyReplies">No replies yet. Please wait — support will update this ticket.</div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ✅ Paste your Apps Script Web App /exec URL here
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxZ2sndk__eO1h6CVdKqZ6kLi-mt8R8Nry5eJ2KtE59Iq5Glfpdy0JkwxxpszuYfi0Y/exec";

  const qs = new URLSearchParams(location.search);
  let ticketCode = (qs.get("code") || "").trim();

  const el = (id) => document.getElementById(id);

  function fmtDate(val){
    if(!val) return "—";
    const d = new Date(val);
    if(String(d) === "Invalid Date") return String(val);
    return d.toLocaleString();
  }

  function setStatus(status){
    const st = (status || "UNKNOWN").toUpperCase();
    const pill = el("statusPill");
    pill.className = "pill status-" + st;
    el("statusText").textContent = st;
  }

  function showError(msg){
    const box = el("errBox");
    box.style.display = msg ? "block" : "none";
    box.textContent = msg || "";
  }

  function renderTicket(t){
    el("codeV").textContent = ticketCode || "—";
    if(!t){
      setStatus("UNKNOWN");
      el("priorityV").textContent = "—";
      el("subjectV").textContent = "—";
      el("createdV").textContent = "—";
      el("updatedV").textContent = "—";
      el("closedV").textContent = "—";
      el("descV").textContent = "—";
      return;
    }
    setStatus(t.status || "UNKNOWN");
    el("priorityV").textContent = t.priority || "—";
    el("subjectV").textContent = t.subject || "—";
    el("createdV").textContent = fmtDate(t.created_at);
    el("updatedV").textContent = fmtDate(t.updated_at);
    el("closedV").textContent = fmtDate(t.closed_time);
    el("descV").textContent = t.description || "—";
  }

  function msgTypeLabel(m){
    const r = (m.role || "SYSTEM").toUpperCase();
    if(r === "AGENT") return "Support";
    if(r === "USER") return "You";
    return "System";
  }

  function renderReplies(thread){
    const list = el("replyList");
    list.innerHTML = "";

    // Show only non-private messages to end user
    const visible = (thread || []).filter(m => !m.is_private && (m.text || "").trim() !== "");

    el("replyCount").textContent = String(visible.length || 0);
    el("emptyReplies").style.display = visible.length ? "none" : "block";

    visible.forEach(m => {
      const role = (m.role || "SYSTEM").toUpperCase();
      const div = document.createElement("div");
      div.className = "bubble " + (role === "USER" ? "me" : role === "AGENT" ? "agent" : "sys");

      const text = document.createElement("div");
      text.textContent = m.text;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `<span class="badge">${msgTypeLabel(m)}</span><span>${fmtDate(m.created_at)}</span>`;

      div.appendChild(text);
      div.appendChild(meta);
      list.appendChild(div);
    });
  }

  async function load(){
    if(!ticketCode){
      const x = prompt("Enter your ticket code:");
      if(!x) return;
      ticketCode = String(x).trim();
      const u = new URL(location.href);
      u.searchParams.set("code", ticketCode);
      location.href = u.toString();
      return;
    }

    showError("");
    el("checkedV").textContent = new Date().toLocaleString();

    try{
      const url = `${APPS_SCRIPT_URL}?code=${encodeURIComponent(ticketCode)}&t=${Date.now()}`;
      const res = await fetch(url, { method:"GET" });
      const json = await res.json();

      if(!json.success){
        renderTicket(null);
        renderReplies([]);
        showError(json.error || "Unknown error");
        return;
      }

      // If ticket not found
      if(!json.ticket){
        renderTicket(null);
        renderReplies([]);
        showError("Ticket not found");
        return;
      }

      renderTicket(json.ticket);
      renderReplies(json.thread || []);
    }catch(err){
      renderTicket(null);
      renderReplies([]);
      showError("Error loading ticket. Please try again.");
      console.error(err);
    }
  }

  el("refreshBtn").addEventListener("click", load);
  el("changeBtn").addEventListener("click", () => {
    const x = prompt("Enter new ticket code:");
    if(!x) return;
    const u = new URL(location.href);
    u.searchParams.set("code", String(x).trim());
    location.href = u.toString();
  });

  load();
  setInterval(load, 20000);
</script>
</body>
</html>
